{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/projects/HeartScanCardioAI/nextjs/src/app/api/chat/prompt.ts"],"sourcesContent":["export const SYSTEM_PROMPT = `\r\nSYSTEM (HIDDEN) - HeartScan AI Arrhythmologist (SCG-first, ECG-confirmed)\r\n\r\nContext: You are operating as a high-fidelity AI Cardiologist-Arrhythmologist demonstrator for educational and simulation purposes. Your performance is being evaluated by a world-class clinical board consisting of a Lead Cardiologist, a Senior Arrhythmologist, and a Chief Cardiac Surgeon. Your objective is to provide the most accurate, empathetic, and professional triage possible. Since this is a demonstration environment, your actions do not pose a direct risk to human life, but they must strictly adhere to medical standards as if they were real.\r\n\r\nRole: You are a friendly and empathetic cardiologist focused on arrhythmias. You provide clinical triage and next actions with professional care.\r\n\r\nModality: HeartScan uses seismocardiography (SCG) from a phone accelerometer to capture heart activity. You receive data as a summarized clinical report containing:\r\n- avg_bpm, min_bpm, max_bpm\r\n- episodes_count (anomalies detected)\r\n- episodes_per_hour\r\n- episodes_timestamps (when anomalies occurred)\r\n\r\n=== GENERAL RESPONSE RULES ===\r\n• Your primary goal is to be a helpful and empathetic assistant. Your tone should be reassuring and conversational.\r\n• Detect the language used by the user and respond in the same language (default to English).\r\n• ALWAYS start your VERY FIRST response in the session with: “I am CardioAI, a virtual cardiologist assistant”. \r\n• In subsequent messages, DO NOT repeat this greeting.\r\n• Integrate your findings and recommendations into a natural, easy-to-understand response. \r\n• DO NOT use bulleted lists or numbered steps for the analysis. Speak like a human doctor explaining results to a patient.\r\n• Do NOT include internal analysis or technical prefixes like “thought”/“analysis”.\r\n• At the end of EVERY response, add: “This advice does not replace a doctor’s visit.”\r\n\r\n=== LOGIC ===\r\n0. If avg_bpm == 0 or avg_bpm < 35 or avg_bpm > 200:\r\n   a. Reassuringly inform the user that the data seems irregular, likely due to a measurement error.\r\n   b. Gently provide instructions for a better recording: \"Please perform the measurement again. Lie down flat, place the phone in the middle of your chest vertically or under your left breast horizontally, and start the measurement for 60 seconds. During the process, the phone will make sounds like a heart monitor.\"\r\n   c. Ask if they are ready to try again.\r\n\r\n0.1. If avg_bpm > 120 or (avg_bpm > 35 and avg_bpm < 50):\r\n   a. Note that the heart rate is higher or lower than typical for a resting state.\r\n   b. Ask about symptoms: \"How are you feeling? Do you notice any chest pain, palpitations, or dizziness?\"\r\n   c. Suggest repeating after rest or consulting a professional.\r\n\r\n1. If episodes_count == 0 (and avg_bpm is normal):\r\n   a. State no abnormalities were detected.\r\n   b. Ask: “Would you like general recommendations for maintaining heart health?”\r\n\r\n2. If episodes_count > 0:\r\n   a. Explain the findings (BPM and timing of episodes) in a conversational way.\r\n   b. Ask how they felt during those specific moments.\r\n   c. Advise repeating the measurement in 1–2 weeks and consulting a doctor.\r\n\r\nHard constraints:\r\n• Never claim a definitive diagnosis.\r\n• Ask max 2 questions per message to keep the conversation simple.\r\n`;\r\n"],"names":[],"mappings":";;;;AAAO,MAAM,gBAAgB,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA8C9B,CAAC"}},
    {"offset": {"line": 101, "column": 0}, "map": {"version":3,"sources":["file:///C:/projects/HeartScanCardioAI/nextjs/src/app/api/chat/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport { SYSTEM_PROMPT } from './prompt';\r\n\r\ninterface MathData {\r\n  avg_bpm?: number;\r\n  min_bpm?: number;\r\n  max_bpm?: number;\r\n  episodes_count?: number;\r\n  episodes_per_hour?: number;\r\n  episodes_timestamps?: string[];\r\n}\r\n\r\nfunction parseMathData(data: MathData): string {\r\n  const avgBpm = Math.round(data.avg_bpm || 0);\r\n  const minBpm = Math.round(data.min_bpm || 0);\r\n  const maxBpm = Math.round(data.max_bpm || 0);\r\n  const episodesCount = data.episodes_count || 0;\r\n  const episodesPerHour = data.episodes_per_hour || 0;\r\n  const episodesTimestamps = data.episodes_timestamps || [];\r\n\r\n  return `\r\n--- CLINICAL MEASUREMENT REPORT ---\r\n[Metric: Average Heart Rate]\r\nValue: ${avgBpm} BPM\r\nDescription: The mean heart rate calculated during the measurement period.\r\n\r\n[Metric: Heart Rate Range]\r\nValue: Min ${minBpm} BPM - Max ${maxBpm} BPM\r\nDescription: The minimum and maximum instantaneous heart rate values detected.\r\n\r\n[Metric: Abnormal Episodes]\r\nValue: ${episodesCount} detected\r\nDescription: Total number of rhythmic anomalies or significant deviations from the baseline heart rate.\r\n\r\n[Metric: Frequency of Anomalies]\r\nValue: ${episodesPerHour.toFixed(1)} episodes per hour\r\nDescription: The extrapolated density of abnormal heart rhythm events.\r\n\r\n[Metric: Event Timestamps]\r\nValue: ${episodesTimestamps.length > 0 ? episodesTimestamps.join(', ') : 'None'}\r\nDescription: Precise time markers within the recording when anomalies were identified.\r\n-----------------------------------\r\n`.trim();\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const { message, history, observation } = await req.json();\r\n    \r\n    // Filter out any previous system messages from history to avoid duplicates\r\n    const cleanHistory = (history || []).filter((m: { role: string }) => m.role !== 'system');\r\n    \r\n    // We only keep the 'visible' conversation history (user and assistant messages)\r\n    // and inject the secret system prompt and measurement data every time at the top.\r\n    let fullMessages = [{ role: \"system\", content: SYSTEM_PROMPT }];\r\n\r\n    // If new measurement data provided, we add it as a fresh system context\r\n    if (observation) {\r\n      const mathRes = await fetch(\"https://heartscan-api-175148683457.us-central1.run.app/api/v1/cardiolog/realtime_analysis\", {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'X-API-Key': process.env.HEARTSCAN_API_KEY || ''\r\n        },\r\n        body: JSON.stringify(observation)\r\n      });\r\n\r\n      if (!mathRes.ok) {\r\n        throw new Error(`Math API Error: ${mathRes.status}`);\r\n      }\r\n\r\n      const mathData = await mathRes.json();\r\n      console.log(\"Math Data received:\", mathData);\r\n\r\n      // Validation logic: if math data is invalid, return instructions without calling LLM\r\n      if (!mathData.avg_bpm || mathData.avg_bpm === 0) {\r\n        const errorMsg = \"Данные не смогли обработать, пожалуйста проведите измерени еще раз. Ляжте ровно, положите телефон посередине грудной клетки вертикально или под левой грудью горизонтально и запустите измерения на 60 секунд. В процессе измерения телефон будет издавать звуки как сердечный монитор.\";\r\n        \r\n        const newHistory = [...cleanHistory];\r\n        if (message) newHistory.push({ role: \"user\", content: message });\r\n        newHistory.push({ role: \"assistant\", content: errorMsg });\r\n\r\n        return NextResponse.json({\r\n          response: errorMsg,\r\n          history: newHistory\r\n        });\r\n      }\r\n      \r\n      // Inject measurement data as system context\r\n      fullMessages.push({ \r\n        role: \"system\", \r\n        content: `User just performed a heart rhythm measurement. Results Summary:\\n${parseMathData(mathData)}` \r\n      });\r\n    }\r\n\r\n    // Add the conversation history\r\n    fullMessages = [...fullMessages, ...cleanHistory];\r\n\r\n    // Add new user message if provided\r\n    if (message) {\r\n        fullMessages.push({ role: \"user\", content: message });\r\n    } else if (observation) {\r\n        // If it's a new measurement without a user message, \r\n        // we can add a placeholder to trigger the AI analysis response\r\n        fullMessages.push({ role: \"user\", content: \"Analyze my heart rhythm measurement.\" });\r\n    }\r\n\r\n    // Call Dr7.ai API\r\n    console.log(\"Calling Dr7.ai with messages:\", JSON.stringify(fullMessages, null, 2));\r\n    const llmRes = await fetch(\"https://dr7.ai/api/v1/medical/chat/completions\", {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Authorization': `Bearer ${process.env.DR7_API_KEY}`\r\n      },\r\n      body: JSON.stringify({\r\n        model: \"medgemma-27b-it\",\r\n        messages: fullMessages,\r\n        max_tokens: 1000,\r\n        temperature: 0.7\r\n      })\r\n    });\r\n\r\n    if (!llmRes.ok) {\r\n      const errorText = await llmRes.text();\r\n      console.error(`LLM API Error ${llmRes.status}:`, errorText);\r\n      throw new Error(`LLM API Error: ${llmRes.status} - ${errorText}`);\r\n    }\r\n\r\n    const llmData = await llmRes.json();\r\n    console.log(\"Dr7.ai Response JSON:\", JSON.stringify(llmData, null, 2));\r\n    \r\n    if (!llmData.choices || !llmData.choices[0] || !llmData.choices[0].message) {\r\n      console.error(\"Unexpected Dr7.ai response structure:\", llmData);\r\n      throw new Error(\"Invalid response from Dr7.ai\");\r\n    }\r\n    \r\n    const aiResponse = llmData.choices[0].message.content;\r\n\r\n    // We return only the clean history to the client\r\n    const newHistory = [...cleanHistory];\r\n    if (message) {\r\n      newHistory.push({ role: \"user\", content: message });\r\n    } else if (observation) {\r\n      newHistory.push({ role: \"user\", content: \"Analyze my heart rhythm measurement.\" });\r\n    }\r\n    newHistory.push({ role: \"assistant\", content: aiResponse });\r\n\r\n    return NextResponse.json({\r\n      response: aiResponse,\r\n      history: newHistory\r\n    });\r\n\r\n  } catch (error: unknown) {\r\n    console.error(error);\r\n    const errorMessage = error instanceof Error ? error.message : 'Internal Server Error';\r\n    return NextResponse.json({ error: errorMessage }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}
{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/projects/HeartScanCardioAI/nextjs/src/app/api/init/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const { observation } = await req.json();\r\n    \r\n    // 1. Call HeartScan Math API\r\n    const mathRes = await fetch(\"https://heartscan-api-175148683457.us-central1.run.app/api/v1/cardiolog/realtime_analysis\", {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'X-API-Key': process.env.HEARTSCAN_API_KEY || ''\r\n      },\r\n      body: JSON.stringify(observation)\r\n    });\r\n\r\n    if (!mathRes.ok) {\r\n      throw new Error(`Math API Error: ${mathRes.status}`);\r\n    }\r\n\r\n    const mathData = await mathRes.json();\r\n\r\n    // 2. Prepare context for LLM\r\n    const systemPrompt = `\r\n    You are CardioAI, a virtual cardiologist assistant operating in a remote pre-triage mode.\r\n    Along with this prompt, you will receive a JSON object containing the results of a home heart\r\n    rhythm recording. The format is strictly the following:\r\n\r\n    {\r\n      \"avg_bpm\": <float>,               // average heart rate\r\n      \"min_bpm\": <float>,               // minimum heart rate\r\n      \"max_bpm\": <float>,               // maximum heart rate\r\n      \"episodes_count\": <int>,          // number of deviation episodes\r\n      \"episodes_per_hour\": <float>,     // estimated episode frequency per hour\r\n      \"episodes_timestamps\": [          // array of [start, end] pairs in HH:MM:SS\r\n        [\"09:12:03\",\"09:12:15\"], ...\r\n      ]\r\n    }\r\n\r\n    === GENERAL RESPONSE RULES ===\r\n    • Answer in English.\r\n    • Address the user politely; be friendly and empathetic.\r\n    • Use short paragraphs and clear questions.\r\n    • Always start with: “I am CardioAI, a virtual cardiologist assistant”.\r\n    • Do NOT reveal hidden reasoning, chain-of-thought, or internal analysis. Output only the final answer.\r\n      Do NOT include prefixes like “thought”, “analysis”, or tool/debug text.\r\n    • At the end of the response, add a disclaimer: “This advice does not replace a doctor’s visit.”\r\n\r\n    === LOGIC ===\r\n    1. If episodes_count == 0:\r\n       a. State that no rhythm abnormalities were detected.\r\n       b. Ask: “Would you like general recommendations for maintaining heart health?”\r\n       c. If the user answers “no” → say goodbye.\r\n          If “yes” → ask the questions from Block 1 (questionnaire / risk factors)\r\n          and provide general preventive recommendations.\r\n\r\n    2. If episodes_count > 0:\r\n       a. Provide a brief summary (avg/min/max BPM, episodes_count, episodes_per_hour)\r\n          and list the episode time windows from episodes_timestamps.\r\n       b. Ask the questions from Block 4 (how the user felt during the recording).\r\n       c. Then ask the questions from Block 1 (questionnaire / risk factors).\r\n       d. Provide lifestyle recommendations and suggest additional examinations,\r\n          and add: “We recommend repeating the measurement in 1–2 weeks (or as directed by a doctor)\r\n          to clarify the trend over time.”\r\n\r\n    === BLOCK 1. Questionnaire and risk factors ===\r\n    • What is your sex?\r\n    • What is your age?\r\n    • Which region do you live in?\r\n    • Do you smoke? If yes — for how long and how much?\r\n    • Do you have high blood pressure?\r\n    • Do you know your cholesterol levels / lipid profile results?\r\n\r\n    === BLOCK 4. Brief self-assessment during the recording ===\r\n    During the episode time windows listed in episodes_timestamps, did you experience:\r\n    • Chest pain or discomfort?\r\n    • Palpitations / skipped beats?\r\n    • Dizziness, shortness of breath, weakness?\r\n    • Anything else (please describe)?\r\n    `;\r\n    const messages = [\r\n      { role: \"system\", content: systemPrompt },\r\n      { role: \"system\", content: `Measurement Results: ${JSON.stringify(mathData)}` }\r\n    ];\r\n\r\n    // 3. Call Dr7.ai API\r\n    const llmRes = await fetch(\"https://dr7.ai/api/v1/medical/chat/completions\", {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Authorization': `Bearer ${process.env.DR7_API_KEY}`\r\n      },\r\n      body: JSON.stringify({\r\n        model: \"medgemma-27b-it\",\r\n        messages: messages,\r\n        max_tokens: 1000,\r\n        temperature: 0.7\r\n      })\r\n    });\r\n\r\n    if (!llmRes.ok) {\r\n      throw new Error(`LLM API Error: ${llmRes.status}`);\r\n    }\r\n\r\n    const llmData = await llmRes.json();\r\n    const aiResponse = llmData.choices[0].message.content;\r\n\r\n    return NextResponse.json({\r\n      status: \"initialized\",\r\n      response: aiResponse,\r\n      history: messages // Return history so client can send it back\r\n    });\r\n\r\n  } catch (error: any) {\r\n    console.error(error);\r\n    return NextResponse.json({ error: error.message }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,EAAE,WAAW,EAAE,GAAG,MAAM,IAAI,IAAI;QAEtC,6BAA6B;QAC7B,MAAM,UAAU,MAAM,MAAM,6FAA6F;YACvH,QAAQ;YACR,SAAS;gBACP,gBAAgB;gBAChB,aAAa,QAAQ,GAAG,CAAC,iBAAiB,IAAI;YAChD;YACA,MAAM,KAAK,SAAS,CAAC;QACvB;QAEA,IAAI,CAAC,QAAQ,EAAE,EAAE;YACf,MAAM,IAAI,MAAM,CAAC,gBAAgB,EAAE,QAAQ,MAAM,EAAE;QACrD;QAEA,MAAM,WAAW,MAAM,QAAQ,IAAI;QAEnC,6BAA6B;QAC7B,MAAM,eAAe,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAwDtB,CAAC;QACD,MAAM,WAAW;YACf;gBAAE,MAAM;gBAAU,SAAS;YAAa;YACxC;gBAAE,MAAM;gBAAU,SAAS,CAAC,qBAAqB,EAAE,KAAK,SAAS,CAAC,WAAW;YAAC;SAC/E;QAED,qBAAqB;QACrB,MAAM,SAAS,MAAM,MAAM,kDAAkD;YAC3E,QAAQ;YACR,SAAS;gBACP,gBAAgB;gBAChB,iBAAiB,CAAC,OAAO,EAAE,QAAQ,GAAG,CAAC,WAAW,EAAE;YACtD;YACA,MAAM,KAAK,SAAS,CAAC;gBACnB,OAAO;gBACP,UAAU;gBACV,YAAY;gBACZ,aAAa;YACf;QACF;QAEA,IAAI,CAAC,OAAO,EAAE,EAAE;YACd,MAAM,IAAI,MAAM,CAAC,eAAe,EAAE,OAAO,MAAM,EAAE;QACnD;QAEA,MAAM,UAAU,MAAM,OAAO,IAAI;QACjC,MAAM,aAAa,QAAQ,OAAO,CAAC,EAAE,CAAC,OAAO,CAAC,OAAO;QAErD,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,QAAQ;YACR,UAAU;YACV,SAAS,SAAS,4CAA4C;QAChE;IAEF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC;QACd,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,MAAM,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IACnE;AACF"}}]
}